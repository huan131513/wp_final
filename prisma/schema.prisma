generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  name      String   @unique
  password  String
  role      Role     @default(MEMBER)
  
  bio       String?  // 新增：個人簡介
  avatar    String?  // 新增：頭像 (儲存 Emoji 或 URL)
  
  reviews   Review[]
  reviewLikes ReviewLike[] // 新增：評論點讚關聯
  reports   Report[]
  requests  FacilityRequest[]
  achievements UserAchievement[]
  savedLocations SavedLocation[] // 新增：收藏關聯
  notifications  Notification[]  // 新增：通知關聯
  checkIns       CheckIn[]       // 新增：打卡關聯
  gameScores     GameScore[]     // 新增：遊戲分數關聯

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Location {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        LocationType
  lat         Float
  lng         Float
  floor       String?
  
  // Common facilities
  hasTissue   Boolean      @default(false)
  hasDryer    Boolean      @default(false)
  
  // Toilet specific
  hasSeat     Boolean      @default(false) // 坐式馬桶

  // Nursing Room specific
  hasDiaperTable   Boolean @default(false) // 尿布檯
  hasWaterDispenser Boolean @default(false) // 飲水機
  hasAutoDoor      Boolean @default(false) // 自動門

  // Accessible Toilet specific
  hasHandrail      Boolean @default(false) // 扶手

  reviews     Review[]
  reports     Report[]
  savedBy     SavedLocation[] // 新增：被收藏關聯
  checkIns    CheckIn[]       // 新增：打卡關聯

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([type])
}

// ... existing models ...

model SavedLocation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  locationId String
  location  Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, locationId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      NotificationType
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  SYSTEM
  REPLY
  APPROVAL
  ACHIEVEMENT
}

model Review {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  userName    String   // Keeping for guest/legacy reviews if needed, or just snapshot
  rating      Int?     // 1-5 stars (null for replies)
  comment     String
  
  // 新增：回覆功能
  parentId    String?  // 回覆的父評論 ID（null 表示頂層評論）
  parent      Review?  @relation("ReviewReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Review[] @relation("ReviewReplies")
  
  // 新增：編輯和刪除功能
  editedAt    DateTime? // 編輯時間（null 表示未編輯過）
  isDeleted   Boolean   @default(false) // 軟刪除標記
  
  // 新增：點讚功能
  likes       ReviewLike[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([locationId])
  @@index([userId])
  @@index([parentId])
}

model Report {
  id          String   @id @default(uuid())
  content     String
  type        ReportType @default(OTHER) // 新增：回報類型
  status      ReportStatus @default(PENDING)
  adminReply  String?      // 新增：管理員回覆
  
  locationId  String
  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([locationId])
  @@index([userId])
  @@index([status])
}

enum ReportType {
  CLEAN         // 正常/已恢復
  NO_PAPER      // 缺紙
  DIRTY         // 髒亂
  MAINTENANCE   // 維修/故障
  CLOGGED       // 堵塞
  OTHER         // 其他
}

model FacilityRequest {
  id          String   @id @default(uuid())
  data        Json     // Stores the location data to be added
  status      RequestStatus @default(PENDING)
  adminReply  String?      // 新增：管理員回覆
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String
  criteriaType String   // e.g., "REVIEW_COUNT", "REPORT_COUNT"
  threshold    Int      // e.g., 1, 5, 10

  users       UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
}

enum LocationType {
  TOILET
  ACCESSIBLE_TOILET
  NURSING_ROOM
}

enum Role {
  ADMIN
  MEMBER
}

enum ReportStatus {
  PENDING
  RESOLVED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model ReviewLike {
  id        String   @id @default(uuid())
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([reviewId, userId]) // 防止重複點讚
}

model CheckIn {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  locationId String
  location  Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([locationId])
  @@index([userId])
  @@index([createdAt])
}

// 遊戲相關模型

enum GameType {
  MINESWEEPER
  GAME_2048
  SUDOKU
  WATER_SORT
}

model GameScore {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  gameType  GameType
  score     Int      // 分數或花費時間（單位：秒或分，視遊戲而定）
  level     Int?     // 關卡等級（用於 Water Sort 等有等級的遊戲）
  playedAt  DateTime @default(now())

  @@index([gameType, score]) // 加快排行榜查詢
  @@index([gameType, level, score]) // 加快按關卡查詢排行榜
}
