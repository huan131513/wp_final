# 評論系統優化計畫

## 📋 目標
將現有的評論系統升級為更社群化的互動平台，增加回覆、點讚、編輯、刪除等功能，提升用戶參與度和互動體驗。

---

## 🗄️ 第一階段：資料庫架構擴充

### 1.1 更新 Prisma Schema

#### 新增欄位到 Review 模型
```prisma
model Review {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  userName    String
  rating      Int      // 1-5 stars
  comment     String
  
  // 新增欄位
  parentId    String?  // 回覆的父評論 ID（null 表示頂層評論）
  parent      Review?  @relation("ReviewReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Review[] @relation("ReviewReplies")
  
  editedAt    DateTime? // 編輯時間（null 表示未編輯過）
  isDeleted   Boolean   @default(false) // 軟刪除標記
  
  likes       ReviewLike[] // 點讚關聯
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

#### 新增 ReviewLike 模型
```prisma
model ReviewLike {
  id        String   @id @default(uuid())
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([reviewId, userId]) // 防止重複點讚
}
```

#### 更新 User 模型
```prisma
model User {
  // ... 現有欄位
  reviews     Review[]
  reviewLikes ReviewLike[] // 新增：點讚關聯
  // ... 其他欄位
}
```

---

## 🔌 第二階段：API 路由擴充

### 2.1 擴展現有 `/api/reviews/route.ts`

**功能擴充：**
- ✅ `POST` - 創建評論（已存在，需支援 parentId）
- ✅ `GET` - 獲取特定地點的所有評論（含回覆和點讚數）

### 2.2 新增 `/api/reviews/[id]/route.ts`

**功能：**
- `GET` - 獲取單一評論詳情（含回覆）
- `PUT` - 編輯評論（僅限作者）
- `DELETE` - 刪除評論（僅限作者或管理員，軟刪除）

### 2.3 新增 `/api/reviews/[id]/replies/route.ts`

**功能：**
- `GET` - 獲取評論的所有回覆
- `POST` - 新增回覆

### 2.4 新增 `/api/reviews/[id]/likes/route.ts`

**功能：**
- `POST` - 點讚/取消點讚（toggle）
- `GET` - 獲取點讚列表（可選，用於顯示誰點讚了）

---

## 🎨 第三階段：前端 UI/UX 優化

### 3.1 ReviewSection 組件重構

#### 功能清單：
1. **評論顯示**
   - ✅ 顯示頂層評論
   - ✅ 顯示回覆（嵌套結構，最多 2 層）
   - ✅ 顯示點讚數和點讚按鈕
   - ✅ 顯示編輯/刪除按鈕（僅限自己的評論）

2. **互動功能**
   - ✅ 回覆按鈕（展開回覆表單）
   - ✅ 點讚按鈕（即時更新）
   - ✅ 編輯按鈕（展開編輯表單）
   - ✅ 刪除按鈕（確認對話框）

3. **UI 改進**
   - ✅ 更好的視覺層次（回覆縮排）
   - ✅ 載入狀態指示
   - ✅ 錯誤處理和提示
   - ✅ 響應式設計

### 3.2 新增組件

#### `ReviewItem.tsx`
- 單一評論的顯示組件
- 包含點讚、回覆、編輯、刪除功能

#### `ReplyForm.tsx`
- 回覆表單組件
- 可重用於頂層評論和回覆

#### `EditReviewModal.tsx`
- 編輯評論的彈出視窗
- 保留原始評分和內容

---

## 📊 第四階段：通知系統整合

### 4.1 通知觸發時機

1. **回覆通知**
   - 當有人回覆我的評論時
   - 當有人回覆我回覆過的評論時（可選）

2. **點讚通知**（可選）
   - 當我的評論獲得點讚時
   - 可設定閾值（例如：10 個點讚才通知）

### 4.2 通知 API 整合
- 在創建回覆時觸發通知
- 使用現有的 `Notification` 模型

---

## 🎯 第五階段：進階功能（可選）

### 5.1 評論排序
- 最新優先（預設）
- 最熱門優先（按點讚數）
- 評分最高優先

### 5.2 評論過濾
- 只看頂層評論
- 只看回覆
- 只看我的評論

### 5.3 評論搜尋
- 在評論中搜尋關鍵字

### 5.4 舉報功能
- 舉報不當評論
- 管理員審核機制

### 5.5 表情符號反應（進階）
- 除了點讚，還可以添加其他反應（👍 👎 ❤️ 😂 等）

---

## 🔄 實作順序建議

### Phase 1: 核心功能（優先）
1. ✅ 資料庫架構更新（Schema + Migration）
2. ✅ API 路由：回覆功能
3. ✅ API 路由：點讚功能
4. ✅ 前端：回覆 UI
5. ✅ 前端：點讚 UI

### Phase 2: 完善功能
6. ✅ API 路由：編輯/刪除
7. ✅ 前端：編輯/刪除 UI
8. ✅ 通知系統整合

### Phase 3: 優化與進階
9. ✅ UI/UX 優化
10. ✅ 排序和過濾功能
11. ✅ 舉報功能（如需要）

---

## 📝 技術細節

### API 回應格式範例

#### 獲取評論（含回覆和點讚）
```json
{
  "id": "uuid",
  "userName": "使用者名稱",
  "user": {
    "id": "uuid",
    "name": "使用者名稱",
    "avatar": "data:image/..."
  },
  "rating": 5,
  "comment": "評論內容",
  "parentId": null,
  "replies": [
    {
      "id": "uuid",
      "userName": "回覆者",
      "comment": "回覆內容",
      "parentId": "父評論ID",
      "likesCount": 3,
      "isLiked": false,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "likesCount": 10,
  "isLiked": true,
  "canEdit": true,
  "canDelete": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "editedAt": null
}
```

### 前端狀態管理
- 使用 React state 管理評論列表
- 使用 optimistic updates 提升 UX
- 錯誤處理和重試機制

---

## 🎨 UI/UX 設計要點

1. **視覺層次**
   - 頂層評論：完整卡片樣式
   - 回覆：縮排 + 較小字體 + 淺色背景

2. **互動反饋**
   - 點讚：即時動畫效果
   - 回覆：展開/收起動畫
   - 載入：骨架屏或載入指示器

3. **響應式設計**
   - 手機：單欄顯示
   - 桌面：可考慮雙欄或更寬的顯示

4. **無障礙設計**
   - 鍵盤導航支援
   - ARIA 標籤
   - 顏色對比度

---

## ✅ 驗收標準

### 功能驗收
- [ ] 可以對評論進行回覆
- [ ] 可以點讚/取消點讚評論
- [ ] 可以編輯自己的評論
- [ ] 可以刪除自己的評論
- [ ] 回覆會正確嵌套顯示
- [ ] 點讚數會即時更新
- [ ] 收到回覆時會收到通知

### 效能驗收
- [ ] 評論載入時間 < 500ms
- [ ] 點讚操作 < 200ms 回應
- [ ] 支援大量評論（100+）的顯示

### UI/UX 驗收
- [ ] 介面美觀且一致
- [ ] 互動流暢無卡頓
- [ ] 錯誤提示清晰
- [ ] 響應式設計正常

---

## 🚀 開始實作

準備好開始實作時，請告知要從哪個階段開始，我會協助您逐步完成！

